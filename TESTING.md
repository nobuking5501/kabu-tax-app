# 🧪 動作確認手順

このアプリケーションが正しく実装されているか確認する手順です。

## 前提条件

1. ローカル環境でアプリが起動している
   ```bash
   npm run dev
   ```

2. ブラウザで `http://localhost:3001` を開いている

## 📝 確認手順

### 方法1: サンプルデータを使った確認（推奨）

1. **フォームページを開く**
   - ログインページから「Googleでログイン」をクリック
   - 自動で `/payment` ページに遷移するので、そこから `/form` に移動
   - または直接 `http://localhost:3001/form` を開く

2. **サンプルデータを読み込む**
   - ページ上部の青いボックス内にある2つのボタンのいずれかをクリック：
     - 📝 **シンプル（100株購入→全売却）**: 基本的な売買パターン
     - 📊 **複雑（複数回売買・年度跨ぎ）**: より実践的な複数取引

3. **自動入力されるデータ**

   **シンプルパターン:**
   - Email: test@example.com
   - 通貨: USD
   - 銘柄: GOOGL
   - 対象年度: 2024
   - 取引:
     - 2024/01/10: 100株購入 @ $150 (手数料$10)
     - 2024/06/15: 100株売却 @ $180 (手数料$5)

   **複雑パターン:**
   - Email: test@example.com
   - 通貨: USD
   - 銘柄: AAPL
   - 対象年度: 2024, 2025
   - 取引:
     - 2024/01/10: 50株購入 @ $100 (手数料$5)
     - 2024/03/15: 50株購入 @ $120 (手数料$5)
     - 2024/06/20: 75株売却 @ $150 (手数料$10)
     - 2024/12/10: 30株購入 @ $140 (手数料$3)
     - 2025/02/15: 35株売却 @ $160 (手数料$8)

4. **計算結果を取得**
   - 「計算結果を取得する」ボタンをクリック
   - PDFファイルが自動ダウンロードされます

5. **結果を確認**
   - ダウンロードされたPDFを開く
   - 以下の項目が正しく計算されているか確認：
     - ✅ 年度別の売却株数
     - ✅ 売却代金（円換算）
     - ✅ 実現損益（キャピタルゲイン）
     - ✅ 残存保有株式数

### 方法2: 手動入力での確認

1. **基本情報を入力**
   - Email: 任意のメールアドレス
   - 通貨: USD または EUR
   - 銘柄: 任意の株式シンボル（例: TSLA, MSFT）
   - 対象年度: 計算したい年度（例: 2024）

2. **取引データを入力**
   - 取引日: 実際の取引日
   - 取得or売却: Purchased（購入）または Sold（売却）
   - 数量:
     - Purchased: 正の数（例: 100）
     - Sold: **負の数**（例: -50）
   - 株価: 取引時の価格
   - 手数料: 任意（空欄可）

3. **注意事項**
   - ⚠️ 売却（Sold）の場合、数量は**必ずマイナス**で入力
   - ⚠️ 保有数量を超える売却はエラーになります
   - 行の追加は「+ 行を追加」ボタン
   - 最大50行まで入力可能

## ✅ 確認ポイント

### 1. 為替換算の確認
- USD/EUR建ての取引が正しく円換算されているか
- 取引日の為替レート（TTS/TTB）が使用されているか
- 週末・祝日の場合、前営業日のレートが使われているか（最大5日前まで遡る）

### 2. 移動平均法の確認
- 複数回購入した場合、平均取得単価が計算されているか
- 売却時に古い保有分から順に消化されているか（FIFO）

### 3. 年度別集計の確認
- 指定した年度ごとに正しく集計されているか
- 年度をまたぐ取引が正しく分類されているか

### 4. エラー処理の確認
- 保有数量を超える売却でエラーが表示されるか
- 売却時にマイナス入力していない場合、エラーが表示されるか
- 必須項目が空の場合、送信がブロックされるか

## 🔍 期待される計算結果（シンプルパターン）

**入力:**
- 2024/01/10: 100株購入 @ $150 (手数料$10)
- 2024/06/15: 100株売却 @ $180 (手数料$5)

**期待される出力（概算）:**
- 取得原価: 約218万円
  - (100株 × $150 + $10) × 145.50円/$ ≈ 2,182,995円
- 売却代金: 約280万円
  - 100株 × $180 × 155.50円/$ ≈ 2,799,000円
- 手数料: 約787円
  - $5 × 157.50円/$ ≈ 787円
- 実現損益: 約61万円
  - 2,799,000 - 787 - 2,182,995 ≈ 615,218円

※ 為替レートは実際のFXデータに基づきます

## 📊 期待される計算結果（複雑パターン）

**2024年度:**
- 売却株数: 75株
- 保有残: 5株

**2025年度:**
- 売却株数: 35株
- 保有残: -30株（マイナスはないので、実際は20株残存）

## 🐛 トラブルシューティング

### PDFがダウンロードされない
- ブラウザのコンソールを開いてエラーを確認
- ネットワークタブでAPIレスポンスを確認
- サーバーログを確認（ターミナル）

### 計算結果がおかしい
- 為替データ（public/fx/*.json）が正しく配置されているか確認
- テストを実行: `npm test`
- 全テストが通過するか確認（18/18 passed）

### エラーメッセージが表示される
- エラーメッセージの内容を確認
- 入力データが正しいか再確認
- 特に売却時の数量がマイナスになっているか確認

## 📝 その他の確認方法

### テストの実行
```bash
npm test
```
全18テストが成功すれば、コア機能は正常です。

### ビルドの確認
```bash
npm run build
```
エラーなくビルドが完了すれば、本番環境にデプロイ可能です。

### 型チェック
```bash
npx tsc --noEmit
```
TypeScriptの型エラーがないことを確認できます。
